name: News Bot

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'news/**'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: yourplace-news-bot
  ECS_SERVICE: yourplace-news-bot
  ECS_CLUSTER: yourplace-news-bot

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout Code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8 # v5.1.0
      with:
        role-to-assume: arn:aws:iam::306570693158:role/news-bot-github-actions
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1

    - name: Build and Push Docker Image
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -f news/Dockerfile -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG news/
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Get Current Task Definition
      id: get-task-def
      run: |
        aws ecs describe-task-definition \
          --task-definition yourplace-news-bot \
          --region ${{ env.AWS_REGION }} \
          --query 'taskDefinition' \
          > task-definition.json

    - name: Update Task Definition with New Image and Env Vars
      id: update-task-def
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
        CONFIG_JSON: ${{ secrets.NEWS_BOT_CONFIG_JSON }}
        WALLET_JSON: ${{ secrets.NEWS_BOT_WALLET_JSON }}
      run: |
        jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" \
           --arg CONFIG_JSON "$CONFIG_JSON" \
           --arg WALLET_JSON "$WALLET_JSON" \
           '.containerDefinitions[0].image = $IMAGE |
            .containerDefinitions[0].environment = [
              {"name": "CONFIG_JSON", "value": $CONFIG_JSON},
              {"name": "WALLET_JSON", "value": $WALLET_JSON}
            ] |
            del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
           task-definition.json > new-task-definition.json
        aws ecs register-task-definition \
          --cli-input-json file://new-task-definition.json \
          --region ${{ env.AWS_REGION }}

    - name: Update ECS Service
      run: |
        LATEST_TASK_DEF=$(aws ecs describe-task-definition \
          --task-definition yourplace-news-bot \
          --region ${{ env.AWS_REGION }} \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)
        aws ecs update-service \
          --cluster ${{ env.ECS_CLUSTER }} \
          --service ${{ env.ECS_SERVICE }} \
          --task-definition $LATEST_TASK_DEF \
          --force-new-deployment \
          --region ${{ env.AWS_REGION }}

    - name: Wait for Service Stability
      run: |
        aws ecs wait services-stable \
          --cluster ${{ env.ECS_CLUSTER }} \
          --services ${{ env.ECS_SERVICE }} \
          --region ${{ env.AWS_REGION }}
